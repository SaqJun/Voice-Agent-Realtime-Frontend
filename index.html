<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aizen • Voice Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }
    .shimmer { background-image: linear-gradient(110deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.08) 20%, rgba(255,255,255,0) 40%); background-size: 200% 100%; animation: shimmer 6s linear infinite; }
    @keyframes floaty { 0%{transform:translateY(0)} 50%{transform:translateY(-4px)} 100%{transform:translateY(0)} }
    .floaty { animation: floaty 6s ease-in-out infinite; }
    .aizen-grid {
      background-image:
        radial-gradient(ellipse at top left, rgba(99,102,241,.15), transparent 60%),
        radial-gradient(ellipse at bottom right, rgba(168,85,247,.12), transparent 60%),
        linear-gradient(rgba(255,255,255,.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.02) 1px, transparent 1px);
      background-size: 100% 100%, 100% 100%, 24px 24px, 24px 24px;
    }
    .gradient-border { position: relative; }
    .gradient-border::before {
      content: ''; position: absolute; inset: 0; padding: 1px; border-radius: 1rem;
      background: linear-gradient(135deg, rgba(99,102,241,.45), rgba(168,85,247,.45));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none;
    }
    /* State-driven orb color */
    #appRoot[data-state="idle"]    #hogyoku { background-image: linear-gradient(135deg, #6366f1, #a855f7); }
    #appRoot[data-state="listening"] #hogyoku { background-image: linear-gradient(135deg, #60a5fa, #818cf8); }
    #appRoot[data-state="thinking"]  #hogyoku { background-image: linear-gradient(135deg, #f59e0b, #6366f1); }
    #appRoot[data-state="speaking"]  #hogyoku { background-image: linear-gradient(135deg, #22c55e, #10b981); }
    /* Thinking shimmer bar under header */
    #appRoot[data-state="thinking"] #thinkingBar { opacity: 1; transform: scaleX(1); }
    /* VU meter bars */
    .vu-bar { height: 6px; border-radius: 9999px; background: linear-gradient(90deg, rgba(99,102,241,.7), rgba(168,85,247,.7)); transition: width .12s ease; }
    /* Scroll to bottom button */
    #scrollBtn { opacity: 0; transform: translateY(8px); pointer-events: none; }
    #scrollBtn[data-show="true"] { opacity: 1; transform: translateY(0); pointer-events: auto; }
    /* Toast root */
    #toast-root { position: fixed; bottom: 16px; right: 16px; display: flex; flex-direction: column; gap: 8px; z-index: 50; }
    #chat-log { -ms-overflow-style: none; scrollbar-width: none; }
    #chat-log::-webkit-scrollbar { width: 0; height: 0; display: none; }

    /* Hide the “Jump to latest” button since auto-scroll is always on */
    #scrollBtn { display: none !important; }
  </style>
</head>

<body class="relative min-h-screen w-screen bg-slate-950 text-slate-100 overflow-hidden flex items-center justify-center">
  <div aria-hidden="true" class="pointer-events-none absolute inset-0 -z-10 aizen-grid"></div>

  <!-- Responsive container: fits small screens and caps on large -->
  <div id="appRoot" data-state="idle" class="w-full max-w-xl h-[78vh] min-h-[560px] max-h-[760px] mx-4 flex flex-col bg-slate-900/60 backdrop-blur-md rounded-2xl shadow-2xl shadow-indigo-900/20 ring-1 ring-white/5 gradient-border overflow-hidden">

    <!-- Header -->
    <header class="px-5 py-4 md:px-6 md:py-5 border-b border-white/10">
      <div class="flex items-center justify-between gap-4">
        <!-- Left: brand -->
        <div class="flex items-center gap-4 min-w-0">
          <div class="relative h-11 w-11 rounded-full bg-gradient-to-br from-indigo-500 to-fuchsia-600 p-[2px] shrink-0">
            <img src="/aizen-avatar.png" alt="Aizen" class="h-full w-full rounded-full object-cover" onerror="this.outerHTML='<div class=&quot;h-full w-full rounded-full bg-slate-900 flex items-center justify-center text-sm font-semibold&quot;>A</div>'">
            <span class="absolute inset-0 rounded-full shimmer opacity-20"></span>
          </div>
          <div class="min-w-0">
            <h1 class="text-base md:text-lg font-semibold tracking-wide leading-tight">Sōsuke Aizen</h1>
            <div class="flex items-center gap-2 text-xs text-slate-400 leading-none mt-1">
              <span id="statusText" class="opacity-80">Idle</span>
              <span class="opacity-60">•</span>
              <span class="opacity-80 truncate">Kyōka Suigetsu Link</span>
            </div>
          </div>
        </div>

        <!-- Right: controls -->
        <div class="flex items-center gap-2 md:gap-3">
          <!-- Session chip (no-wrap + truncation) -->
          <button id="copySessionBtn" class="group inline-flex h-8 items-center gap-2 px-3 rounded-md bg-white/5 hover:bg-white/10 border border-white/10 text-xs min-w-0 max-w-[50vw] sm:max-w-[260px] whitespace-nowrap">
            <span class="text-slate-300 shrink-0">Session:</span>
            <span id="sessionValue" class="font-mono text-slate-200 truncate">–</span>
          </button>

          <!-- Settings -->
          <button id="openSettingsBtn" class="inline-flex h-8 items-center gap-1.5 px-3 rounded-md bg-white/5 hover:bg-white/10 border border-white/10 text-xs" title="Settings">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-80" viewBox="0 0 24 24" fill="currentColor">
              <path d="M11.983 2a1 1 0 0 1 .984.82l.264 1.505c.302.08.597.187.88.316l1.33-.768a1 1 0 0 1 1.3.267l1.732 2.4a1 1 0 0 1-.234 1.39l-1.27.924c.064.323.097.655.097.987s-.033.664-.097.987l1.27.924a1 1 0 0 1 .234 1.39l-1.732 2.4a1 1 0 0 1-1.3.267l-1.33-.768a6.03 6.03 0 0 1-.88.316l-.264 1.505a1 1 0 0 1-.984.82h-2.4a1 1 0 0 1-.984-.82l-.264-1.505a6.03 6.03 0 0 1-.88-.316l-1.33.768a1 1 0 0 1-1.3-.267l-1.732-2.4a1 1 0 0 1 .234-1.39l1.27-.924A6.7 6.7 0 0 1 6.64 12c0-.332.033-.664.097-.987l-1.27-.924a1 1 0 0 1-.234-1.39l1.732-2.4a1 1 0 0 1 1.3-.267l1.33.768c.283-.129.578-.236.88-.316l.264-1.505A1 1 0 0 1 9.583 2h2.4ZM12 9a3 3 0 1 0 .002 6.002A3 3 0 0 0 12 9Z"/>
            </svg>
            <span class="hidden sm:inline">Settings</span>
          </button>

          <!-- Hogyoku orb -->
          <div id="hogyoku" class="relative h-8 w-8 rounded-full opacity-90 shadow-lg shadow-fuchsia-900/40 floaty shrink-0">
            <span class="absolute inset-[2px] rounded-full bg-slate-900/70 backdrop-blur-sm"></span>
            <span class="absolute inset-0 rounded-full shimmer opacity-30"></span>
          </div>
        </div>
      </div>
    </header>

    <!-- Thinking bar -->
    <div id="thinkingBar" class="h-0.5 opacity-0 scale-x-0 transition-all duration-300 origin-left bg-gradient-to-r from-indigo-500 via-fuchsia-500 to-indigo-500 shimmer"></div>

    <!-- Chat Area -->
    <main id="chat-log" class="relative flex-1 overflow-y-auto px-5 py-4 md:px-6 md:py-5 space-y-4 flex flex-col">
      <!-- Initial agent message -->
      <div class="self-start max-w-[88%] md:max-w-[85%]">
        <div class="bg-gradient-to-r from-indigo-600/30 to-fuchsia-600/30 p-[1px] rounded-2xl">
          <div class="bg-slate-900/70 rounded-2xl px-4 py-3 shadow-md shadow-black/20">
            <p class="text-sm leading-relaxed">Speak, and let the illusion take shape. Tap the mic when you’re ready.</p>
          </div>
        </div>
      </div>

      <!-- Scroll-to-bottom -->
      <button id="scrollBtn" data-show="false" class="absolute bottom-4 left-1/2 -translate-x-1/2 px-3 py-1.5 text-xs rounded-full bg-white/10 hover:bg-white/20 border border-white/10 shadow-lg">
        Jump to latest
      </button>
    </main>

    <!-- Footer -->
    <footer class="px-5 py-4 md:px-6 md:py-5 border-t border-white/10">
      <div class="flex items-center justify-between gap-4">
        <!-- Left: quick controls -->
        <div class="flex items-center gap-3 md:gap-4">
          <!-- VU meter -->
          <div class="w-36 bg-white/5 rounded-full overflow-hidden">
            <div id="vu" class="vu-bar w-2"></div>
          </div>
          <button id="muteBtn" class="inline-flex h-8 items-center px-3 rounded-md bg-white/5 hover:bg-white/10 border border-white/10 text-xs">
            Mute TTS
          </button>
          <button id="resetBtn" class="inline-flex h-8 items-center px-3 rounded-md bg-white/5 hover:bg-white/10 border border-white/10 text-xs">
            Reset Memory
          </button>
        </div>

        <!-- Mic Button (keep this id) -->
        <button id="startAndstopBtn"
          class="relative group inline-flex items-center gap-3 h-10 px-5 md:h-11 md:px-6 rounded-xl bg-gradient-to-r from-indigo-600 to-fuchsia-600 text-white text-sm md:text-base font-medium shadow-lg shadow-indigo-900/30 hover:shadow-fuchsia-900/40 active:scale-[.98] transition-all"
          aria-pressed="false">
          <span class="absolute -inset-1 rounded-xl bg-gradient-to-r from-indigo-600/30 to-fuchsia-600/30 blur-[6px] opacity-0 group-hover:opacity-100 transition" aria-hidden="true"></span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 drop-shadow" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 15a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3ZM6.25 12a.75.75 0 0 0-1.5 0 7.25 7.25 0 0 0 6.5 7.214V21h-2a.75.75 0 0 0 0 1.5h6.5a.75.75 0 0 0 0-1.5h-2v-1.786A7.25 7.25 0 0 0 19.25 12a.75.75 0 0 0-1.5 0 5.75 5.75 0 1 1-11.5 0Z"/>
          </svg>
          <span class="relative z-10">
            <span class="hidden sm:inline">Start Recording</span>
            <span class="sm:hidden">Record</span>
          </span>
        </button>
      </div>
    </footer>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" role="dialog" aria-modal="true" class="hidden fixed inset-0 z-50 items-center justify-center">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="relative w-[min(92vw,680px)] bg-slate-900/95 border border-white/10 rounded-2xl shadow-2xl p-6 md:p-7">
      <div class="flex items-start justify-between gap-4 mb-5">
        <div class="min-w-0">
          <h2 class="text-lg font-semibold leading-tight">API Keys</h2>
          <p class="mt-1 text-xs text-slate-400">Stored locally and sent to the backend for this session. Empty fields fall back to server .env.</p>
        </div>
        <button id="closeSettingsBtn" class="inline-flex h-8 items-center px-3 rounded-md bg-white/5 hover:bg-white/10 border border-white/10 text-xs shrink-0">Close</button>
      </div>

      <form id="settingsForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="flex flex-col gap-1.5">
            <span class="text-xs text-slate-300">Gemini API Key</span>
            <input id="geminiKeyInput" type="password" autocomplete="off" class="px-3 py-2 rounded-md bg-slate-800/70 border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500/50" placeholder="GEMINI_API_KEY" />
          </label>
          <label class="flex flex-col gap-1.5">
            <span class="text-xs text-slate-300">STT API Key</span>
            <input id="sttKeyInput" type="password" autocomplete="off" class="px-3 py-2 rounded-md bg-slate-800/70 border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500/50" placeholder="Speech-to-Text key" />
          </label>
          <label class="flex flex-col gap-1.5">
            <span class="text-xs text-slate-300">TTS API Key</span>
            <input id="ttsKeyInput" type="password" autocomplete="off" class="px-3 py-2 rounded-md bg-slate-800/70 border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500/50" placeholder="Text-to-Speech key" />
          </label>
          <label class="flex flex-col gap-1.5">
            <span class="text-xs text-slate-300">Weather API Key</span>
            <input id="weatherKeyInput" type="password" autocomplete="off" class="px-3 py-2 rounded-md bg-slate-800/70 border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500/50" placeholder="OpenWeather / etc." />
          </label>
          <label class="flex flex-col gap-1.5 md:col-span-2">
            <span class="text-xs text-slate-300">Websearch API Key</span>
            <input id="websearchKeyInput" type="password" autocomplete="off" class="px-3 py-2 rounded-md bg-slate-800/70 border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500/50" placeholder="Search provider key (SerpAPI/Tavily/etc.)" />
          </label>
        </div>

        <div class="flex items-center justify-between pt-1">
          <button id="clearKeysBtn" type="button" class="inline-flex h-9 items-center px-3 rounded-md bg-white/5 hover:bg-white/10 border border-white/10 text-xs">Clear keys (use .env)</button>
          <div class="flex items-center gap-2">
            <button id="showKeysToggle" type="button" class="inline-flex h-9 items-center px-3 rounded-md bg-white/5 hover:bg-white/10 border border-white/10 text-xs">Show</button>
            <button type="submit" class="inline-flex h-9 items-center px-4 rounded-md bg-indigo-600 hover:bg-indigo-500 border border-indigo-400/30 text-xs font-medium">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toast-root"></div>

  <script src="./script.js"></script>
</body>
</html>
